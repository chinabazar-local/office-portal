<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Leave Request · Chinabazar</title>
  <link rel="stylesheet" href="/style.css" />
  <style>
    .leave-shell{
      max-width: 960px;
      margin: 24px auto 40px;
      padding: 0 16px;
    }
    .leave-card{
      background:#fff;
      border:1px solid var(--border);
      border-radius:24px;
      padding:18px;
      box-shadow:0 10px 30px rgba(45,110,173,.08);
    }
    .leave-top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:12px;
      flex-wrap:wrap;
    }
    .signed-pill{
      padding:8px 12px;
      border-radius:999px;
      background:#f1f5f9;
      font-size:13px;
      color:#0f172a;
    }
    .signed-pill strong{
      font-weight:700;
    }
    .leave-frame{
      width:100%;
      min-height:680px;
      border:0;
      border-radius:18px;
      overflow:hidden;
    }
    .leave-frame::backdrop{ background:transparent; }
    .logout-btn{
      border:0;
      border-radius:999px;
      padding:8px 14px;
      font-size:12px;
      font-weight:700;
      background:#0f172a;
      color:#fff;
      cursor:pointer;
    }
    .logout-btn:hover{ background:#111827; }
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
  </style>
</head>
<body>
  <!-- Shared header -->
  <header class="header">
    <div class="brand">
      <div class="logo">CB</div>
      <div class="brand-text">
        <h1>Employee Portal</h1>
        <p class="subtitle">Leave requests · Kathmandu</p>
      </div>
    </div>
    <div class="header-right">
      <nav class="modules">
        <a href="/" class="chip">Clock In/Out</a>
        <a href="/leave-request/" class="chip chip-active">Leave Request</a>
      </nav>
      <button id="btnLogout" class="logout-btn" type="button">Logout</button>
    </div>
  </header>

  <main class="leave-shell">
    <section class="leave-card">
      <div class="leave-top">
        <div class="signed-pill">
          Signed in as <strong id="signedName">—</strong>
        </div>
      </div>

      <!-- Embedded Apps Script web app -->
      <iframe
        id="leaveFrame"
        class="leave-frame"
        title="Leave Request"
        loading="lazy"
      ></iframe>
    </section>
  </main>

  <script>
    const LEAVE_WEBAPP_URL =
      "https://script.google.com/a/macros/chinabazar.com/s/AKfycbwfXrkiHZNZBeQyCFYLKPYEtXJZWls89g2sHA-7FJR54reSoMrKhrxCHn0MEdTx-kSX/exec";

    // Read session from localStorage (set by script_login.js)
    let SESS = {};
    try {
      SESS = JSON.parse(localStorage.getItem("cb_user") || "{}");
    } catch (_) {
      SESS = {};
    }

    const qs = new URLSearchParams(location.search);
    let employeeName = SESS.employeeName || SESS.name || qs.get("employee") || "";

    // If no employee, send back to login
    if (!employeeName) {
      location.href = "/login/";
    }

    // Show name in header
    document.getElementById("signedName").textContent = employeeName;

    // Carry pf_lat / pf_lng through if present
    const pfLat = qs.get("pf_lat");
    const pfLng = qs.get("pf_lng");

    const params = new URLSearchParams();
    params.set("employee", employeeName);
    if (pfLat) params.set("pf_lat", pfLat);
    if (pfLng) params.set("pf_lng", pfLng);

    const iframeSrc = LEAVE_WEBAPP_URL + "?" + params.toString();
    document.getElementById("leaveFrame").src = iframeSrc;

    // Logout: clear session and go to login
    document.getElementById("btnLogout").addEventListener("click", () => {
      localStorage.removeItem("cb_user");
      location.href = "/login/";
    });
  </script>
</body>
</html>
